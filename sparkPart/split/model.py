#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Date    : 2018-05-17 10:39:25
# @Author  : guanglinzhou (xdzgl812@163.com)
# @Link    : https://github.com/GuanglinZhou
# @Version : $Id$


'''

使用RF训练hdfs://master:9000//trainDataDir/trainData_xxx.csv文件

'''

# from __future__ import print_function

from pyspark.ml.classification import RandomForestClassifier
from pyspark.ml.feature import IndexToString, StringIndexer, VectorIndexer
from pyspark.sql import SparkSession
from pyspark.ml.linalg import Vectors
from pyspark.ml.classification import GBTClassifier

# import random

if __name__ == '__main__':
    spark = SparkSession.builder.appName("generateSplitModel").getOrCreate()
    sc = spark.sparkContext

    ilist = [   61034, 61035,
             61036, 61037, 61038, 61039, 61042, 61048, 61049, 61050, 61253, 61258, 61259, 61260, 61270, 61271, 61272,
             61273, 61274, 61276, 61277, 61278, 61280, 61281, 61282, 61285, 61287, 61288, 61289, 61291, 61292, 61293,
             61294, 61295, 61296, 61297, 61299, 61300, 61301, 61302, 61303, 61304, 61305, 61306, 61307, 61310, 61311,
             61312, 61313, 61314, 61315, 61316, 61317, 61319, 61320, 61321, 61322, 61326, 61328, 61329, 61332, 61333,
             61334, 61335, 61336, 61337, 61338, 61339, 61544, 61550, 61554, 61555, 61556, 61561, 61562, 61566, 61567,
             61568, 61569, 61570, 61571, 61572, 61573, 61574, 61579, 61582, 61584, 61585, 61586, 61587, 61588, 61589,
             61590, 61591, 61592, 61593, 61594, 61595, 61596, 61597, 61598, 61599, 61600, 61601, 61602, 61603, 61604,
             61605, 61606, 61607, 61608, 61609, 61610, 61611, 61612, 61614, 61616, 61619, 61620, 61622, 61623, 61624,
             61625, 61626, 61627, 61628, 61629, 61840, 61845, 61846, 61847, 61848, 61849, 61850, 61851, 61852, 61855,
             61856, 61857, 61858, 61859, 61860, 61861, 61864, 61869, 61871, 61872, 61874, 61875, 61876, 61877, 61878,
             61879, 61880, 61881, 61884, 61886, 61887, 61888, 61889, 61890, 61891, 61892, 61893, 61894, 61895, 61896,
             61898, 61899, 61900, 61901, 61902, 61903, 61904, 61905, 61906, 61907, 61908, 61909, 61911, 61912, 61913,
             61914, 61915, 61916, 61917, 61918, 61919, 61920, 61922, 61944, 61945, 61946, 61947, 62130, 62136, 62139,
             62142, 62143, 62145, 62146, 62147, 62148, 62149, 62159, 62164, 62165, 62166, 62167, 62170, 62176, 62177,
             62178, 62179, 62180, 62181, 62182, 62183, 62184, 62185, 62186, 62188, 62189, 62190, 62191, 62192, 62193,
             62194, 62195, 62196, 62197, 62198, 62199, 62200, 62201, 62202, 62203, 62207, 62208, 62209, 62210, 62212,
             62231, 62234, 62235, 62237, 62238, 62240, 62420, 62426, 62427, 62429, 62430, 62431, 62432, 62433, 62435,
             62436, 62437, 62438, 62439, 62443, 62449, 62451, 62452, 62453, 62454, 62456, 62457, 62460, 62464, 62465,
             62466, 62469, 62470, 62471, 62472, 62473, 62474, 62475, 62476, 62477, 62478, 62479, 62480, 62481, 62484,
             62485, 62486, 62487, 62488, 62489, 62490, 62491, 62492, 62499, 62500, 62502, 62519, 62520, 62521, 62523,
             62531, 62709, 62710, 62718, 62719, 62721, 62722, 62739, 62740, 62741, 62742, 62743, 62744, 62747, 62748,
             62749, 62750, 62753, 62754, 62756, 62759, 62760, 62761, 62762, 62763, 62764, 62765, 62766, 62767, 62768,
             62769, 62770, 62771, 62775, 62776, 62777, 62778, 62779, 62780, 62781, 62783, 62789, 62790, 62792, 62809,
             62810, 62811, 62812, 62813, 62814, 63011, 63029, 63030, 63031, 63032, 63033, 63038, 63040, 63041, 63042,
             63043, 63044, 63045, 63046, 63047, 63048, 63049, 63050, 63051, 63052, 63053, 63054, 63055, 63059, 63060,
             63063, 63065, 63066, 63067, 63068, 63069, 63070, 63071, 63072, 63073, 63080, 63081, 63082, 63089, 63098,
             63099, 63101, 63102, 63103, 63104, 63107, 63320, 63321, 63322, 63323, 63324, 63325, 63326, 63328, 63329,
             63330, 63331, 63332, 63334, 63335, 63336, 63337, 63338, 63339, 63340, 63341, 63342, 63344, 63345, 63346,
             63349, 63352, 63353, 63354, 63355, 63356, 63357, 63358, 63359, 63360, 63361, 63362, 63370, 63379, 63397,
             63600, 63611, 63612, 63613, 63614, 63615, 63616, 63617, 63618, 63621, 63622, 63623, 63624, 63625, 63626,
             63627, 63628, 63629, 63630, 63631, 63632, 63633, 63634, 63635, 63642, 63643, 63644, 63645, 63646, 63648,
             63649, 63652, 63660, 63662, 63663, 63664, 63669, 63682, 63683, 63686, 63687, 63688, 63690, 63691, 63692,
             63901, 63905, 63912, 63916, 63917, 63918, 63921, 63922, 63923, 63924, 63925, 63926, 63933, 63934, 63935,
             63936, 63937, 63938, 63942, 63943, 63946, 63948, 63949, 63950, 63958, 63971, 63972, 63973, 63975, 63976,
             63977, 63978, 63979, 63980, 63981, 63982, 63985, 63986, 63987, 64191, 64201, 64204, 64205, 64206, 64207,
             64210, 64212, 64214, 64215, 64220, 64223, 64224, 64225, 64233, 64236, 64237, 64238, 64239, 64240, 64241,
             64242, 64243, 64244, 64246, 64261, 64262, 64263, 64264, 64265, 64266, 64267, 64268, 64269, 64270, 64271,
             64272, 64273, 64274, 64275, 64276, 64488, 64489, 64491, 64492, 64494, 64495, 64496, 64499, 64500, 64504,
             64505, 64509, 64510, 64511, 64512, 64513, 64514, 64515, 64526, 64527, 64528, 64529, 64530, 64532, 64533,
             64534, 64535, 64536, 64546, 64549, 64551, 64552, 64554, 64555, 64556, 64558, 64559, 64560, 64561, 64562,
             64563, 64564, 64565, 64777, 64779, 64780, 64781, 64783, 64784, 64785, 64786, 64787, 64788, 64789, 64790,
             64791, 64794, 64795, 64798, 64799, 64800, 64801, 64802, 64803, 64809, 64815, 64816, 64817, 64818, 64823,
             64833, 64835, 64836, 64837, 64838, 64839, 64840, 64841, 64842, 64843, 64844, 64845, 64846, 64848, 64849,
             64850, 64851, 64852, 65070, 65076, 65077, 65078, 65079, 65080, 65081, 65082, 65083, 65088, 65090, 65091,
             65092, 65094, 65095, 65099, 65101, 65102, 65105, 65107, 65128, 65129, 65130, 65132, 65133, 65134, 65135,
             65136, 65137, 65139, 65140, 65142, 65144, 65145, 65146, 65357, 65358, 65366, 65367, 65368, 65369, 65370,
             65371, 65372, 65374, 65380, 65381, 65382, 65384, 65385, 65386, 65387, 65388, 65389, 65390, 65391, 65392,
             65393, 65394, 65395, 65397, 65419, 65421, 65422, 65424, 65426, 65429, 65430, 65431, 65432, 65433, 65434,
             65435, 65436, 65647, 65648, 65658, 65660, 65661, 65662, 65664, 65665, 65666, 65670, 65671, 65672, 65673,
             65674, 65675, 65676, 65677, 65678, 65679, 65680, 65681, 65682, 65685, 65687, 65710, 65712, 65720, 65721,
             65722, 65723, 65724, 65726, 65930, 65932, 65937, 65938, 65940, 65941, 65942, 65945, 65951, 65952, 65953,
             65954, 65955, 65956, 65957, 65961, 65962, 65963, 65964, 65965, 65966, 65967, 65968, 65969, 65970, 65971,
             65972, 65974, 65975, 65977, 65998, 65999, 66010, 66011, 66014, 66220, 66221, 66222, 66226, 66227, 66229,
             66230, 66232, 66233, 66234, 66235, 66236, 66240, 66241, 66242, 66245, 66246, 66248, 66249, 66252, 66253,
             66254, 66255, 66256, 66261, 66262, 66263, 66265, 66267, 66288, 66289, 66290, 66299, 66300, 66303, 66304,
             66305, 66306, 66497, 66498, 66510, 66515, 66516, 66519, 66520, 66522, 66524, 66525, 66526, 66527, 66531,
             66532, 66533, 66535, 66538, 66539, 66542, 66545, 66546, 66547, 66549, 66550, 66551, 66552, 66553, 66556,
             66560, 66590, 66785, 66786, 66802, 66805, 66809, 66814, 66815, 66820, 66821, 66822, 66823, 66829, 66830,
             66832, 66833, 66834, 66835, 66836, 66843, 66849, 66850, 67073, 67074, 67092, 67094, 67109, 67112, 67120,
             67123, 67125, 67126, 67130, 67133, 67142, 67143, 67147, 67148, 67149, 67363, 67382, 67383, 67384, 67399,
             67401, 67402, 67413, 67414, 67416, 67417, 67419, 67420, 67427, 67428, 67430, 67431, 67432, 67671, 67672,
             67673, 67688, 67689, 67690, 67691, 67701, 67708, 67709, 67718, 67719, 67728, 67961, 67962, 67977, 67978,
             67980, 67981, 67984, 67989, 67990, 67995, 67996, 67997, 67999, 68007, 68009, 68010, 68011, 68017, 68018,
             68019, 68251, 68267, 68268, 68269, 68270, 68274, 68279, 68284, 68285, 68286, 68287, 68288, 68301, 68307,
             68308, 68556, 68557, 68558, 68559, 68560, 68562, 68563, 68569, 68573, 68574, 68575, 68576, 68591, 68597,
             68598, 68846, 68847, 68848, 68849, 68850, 68853, 68858, 68859, 68861, 68866, 68870, 68881, 68885, 68887,
             68888, 68889, 69136, 69137, 69138, 69139, 69140, 69141, 69142, 69144, 69148, 69150, 69151, 69154, 69156,
             69169, 69170, 69171, 69172, 69177, 69425, 69426, 69427, 69429, 69432, 69433, 69434, 69438, 69442, 69443,
             69446, 69455, 69462, 69467, 69715, 69716, 69718, 69722, 69724, 69728, 69731, 69732, 69736, 69742, 69743,
             69744, 69745, 69751, 69752, 69753, 69755, 69757, 70005, 70006, 70008, 70012, 70018, 70030, 70031, 70032,
             70033, 70034, 70042, 70043, 70044, 70045, 70046, 70048, 70049, 70295, 70296, 70297, 70298, 70299, 70300,
             70302, 70303, 70309, 70317, 70318, 70319, 70320, 70324, 70333, 70334, 70336, 70566, 70585, 70586, 70587,
             70588, 70590, 70591, 70592, 70593, 70606, 70607, 70610, 70623, 70624, 70625, 70626, 70855, 70856, 70875,
             70877, 70878, 70879, 70880, 70881, 70882, 70883, 70887, 70901, 70910, 70915, 70916, 71144, 71145, 71146,
             71165, 71166, 71168, 71169, 71170, 71171, 71172, 71202, 71206, 71435, 71436, 71455, 71467, 71485, 71724,
             71744, 71745, 71746, 71747, 71757, 71758, 71771, 71772, 71775, 72012, 72013, 72014, 72015, 72036, 72037,
             72038, 72039, 72060, 72061, 72062, 72325, 72326, 72327, 72328, 72329, 72334, 72348, 72349, 72350, 72591,
             72616, 72617, 72618, 72624, 72625, 72884, 72907, 72908, 72909, 72913, 72916, 72917, 73182, 73194, 73195,
             73197, 73203, 73205, 73472, 73485, 73486, 73487, 73489, 73491, 73492, 73494, 73775, 73776, 73781, 73782,
             73783, 73784, 74061, 74062, 74065, 74066, 74070, 74071, 74072, 74073, 74091, 74351, 74352, 74353, 74354,
             74355, 74356, 74359, 74361, 74362, 74381, 74641, 74642, 74643, 74644, 74645, 74646, 74649, 74650, 74651,
             74652, 74922, 74936, 74940, 75226, 75229, 75230, 75520, 75817, 76384, 76385, 76391, 76397, 76402, 76687,
             76691, 76692, 76962, 77251, 77252, 77255, 77256, 77540, 77541, 77542, 77828, 77829, 77830, 77831, 77832,
             78118, 78119, 78122, 78409, 78410, 78411, 78412, 79862, 80152]
    # indexRange = range(64832, 64838)
    # ilist = random.sample(ilist, 3)
    # ilist = [38116]
    for index in ilist:
        trainData = sc.textFile(
            'hdfs://master:9000//fcd/train_test_4_1_split/397-290_trainDataSplit/trainData_{}.csv'.format(index))
        trainData = trainData.map(lambda line: line.split(','))
        # columnName = trainData.first()
        columnName = trainData.take(1)[0]
        trainData = trainData.filter(lambda row: row != columnName).toDF(columnName)
        trainData = trainData.rdd.map(lambda x: (Vectors.dense(x[0:-1]), x[-1])).toDF(["features", "label"])
        labelIndexer = StringIndexer(inputCol="label", outputCol="indexedLabel").fit(trainData)
        trainData = labelIndexer.transform(trainData)
        label = labelIndexer.labels
        labelDict = {}
        for i in range(len(label)):
            labelDict[label[i]] = i
        labelValIndex = list(labelDict.items())
        labelRdd = sc.parallelize(labelValIndex)
        labelDF = spark.createDataFrame(labelRdd, ['secID', 'index'])
        labelDF.write.save('hdfs://master:9000//fcd/train_test_4_1_split/labelIndexer/labelIndexer_{}'.format(index),
                           format='parquet', mode='append')

        # df = spark.read.format('parquet').load('hdfs://master:9000//sparkExperiment/labelIndexer/labelIndexer_60438')

        rf = RandomForestClassifier(numTrees=5, maxDepth=2, labelCol='indexedLabel', featuresCol='features', seed=42)
        model1 = rf.fit(trainData)
        model1.save('hdfs://master:9000//fcd/train_test_4_1_split/serialModel/model_{}'.format(index))
    sc.stop()
